#!/bin/sh
#
######################################################################
# Autor: Радимир Михайлов (radimir@mobilcard.ru)
# Descr: Скрипт создания дистрибутива системы синхронизации из CVS
# -------------------------------------------------------------------
# $Id $
# -------------------------------------------------------------------
# Самое главное, что делает скрипт:
#
#   - убирает служебные файлы и каталоги CVS
#   - копирует файлы профиля в нужное место
#   - назначает владельцем всех файлов пользователя sync
#   - назначает suid'ные права на программу syncctl
#
######################################################################
#
#ifdef __USAGE
#
#Встроить систему синхронизации в дистрибутив станции
#
#%C <корневой каталог дистрибутива> <имя версии> [<имя профиля>]
#
#Если имя профиля не указано, то используется профиль azs.
#
#endif
#

if [ $# -lt 2 ]
then
	/bin/use $0
	exit 1
fi

# ------------------------------------------------------------------

CVS_MODULE=sync
DEFAULT_PROFILE=azs

PATH_DISTRIB=$1
NAME_VERSION=$2
NAME_PROFILE=${3:-$DEFAULT_PROFILE}

PATH_TARGET=$PATH_DISTRIB/home
PATH_SYNC=$PATH_TARGET/$CVS_MODULE

# ------------------------------------------------------------------

if [ \! -d $PATH_DISTRIB ]
then
  echo "Не найден корневой каталог дистрибутива!"
  exit 1
fi

curdir=`pwd`

if [ \! -d $PATH_TARGET ]; then mkdir $PATH_TARGET; fi
cd $PATH_TARGET

# Изъять файлы системы синхронизации из CVS

rm -f -R $PATH_SYNC
cvs export -r $NAME_VERSION $CVS_MODULE

# Проверить существует ли заданный в командной строке профиль

cd $PATH_SYNC/etc/profiles
if [ \! -d $NAME_PROFILE ]
then
  echo "Профиля $NAME_PROFILE в системе синхронизации не существует!"
  cd $curdir
  exit 1
fi

# Скопировать файлы профиля в главный каталог системы синхронизации

cp -R -c -M unix $NAME_PROFILE/* $PATH_SYNC

# Настроить права файлов

chown -R sync:sync $PATH_SYNC
chmod 7755 $PATH_SYNC/syncctl

cd $curdir
